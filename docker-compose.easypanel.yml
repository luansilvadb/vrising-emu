# ==============================================================================
# V Rising ARM64 Server - Production Docker Compose
# ==============================================================================
# Cross-reference verified with tsx-cloud/vrising-ntsync docker-compose
#
# Deploy options:
# 1. EasyPanel: Import this file via UI
# 2. Direct: docker compose -f docker-compose.easypanel.yml up -d
# ==============================================================================

services:
  vrising:
    # ===========================================================================
    # IMAGE CONFIGURATION
    # ===========================================================================
    # Option 1: Use pre-built tsx-cloud image (RECOMMENDED - battle-tested)
    image: tsxcloud/vrising-ntsync:latest

    # Option 2: Build from local Dockerfile (uncomment below, comment above)
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     WINE_VERSION: "11.0-rc3"

    container_name: vrising-server
    hostname: vrising

    # ===========================================================================
    # ENVIRONMENT VARIABLES
    # Cross-reference: tsx-cloud uses TZ, SERVERNAME, ENABLE_PLUGINS
    # ===========================================================================
    environment:
      # --- Basic Configuration (tsx-cloud compatible) ---
      - TZ=America/Sao_Paulo
      - SERVERNAME=VRising-ARM64
      - ENABLE_PLUGINS=true

      # --- Server Behavior ---
      - UPDATE_SERVER=true
      - LOGDAYS=30

    # ===========================================================================
    # VOLUMES - Persistent Data
    # Cross-reference: tsx-cloud uses same paths
    # ===========================================================================
    volumes:
      - ./vrising/server:/mnt/vrising/server
      - ./vrising/persistentdata:/mnt/vrising/persistentdata

    # ===========================================================================
    # PORTS
    # Cross-reference: tsx-cloud uses same ports
    # ===========================================================================
    ports:
      # Game Port (UDP) - REQUIRED
      - "9876:9876/udp"
      # Query Port (UDP) - For server browser
      - "9877:9877/udp"
      # RCON Port (TCP) - Remote administration
      - "25575:25575/tcp"
      # API/Metrics Port (TCP) - Prometheus metrics
      - "9099:9090/tcp"

    # ===========================================================================
    # RESTART POLICY
    # ===========================================================================
    restart: unless-stopped

    # ===========================================================================
    # GRACEFUL SHUTDOWN
    # tsx-cloud uses 30s, we use 60s for extra safety
    # ===========================================================================
    stop_grace_period: 60s

    # ===========================================================================
    # NETWORK
    # ===========================================================================
    network_mode: bridge

    # ===========================================================================
    # NTSYNC DEVICE
    # Cross-reference: tsx-cloud has this enabled by default
    # IMPORTANT: Only uncomment if YOUR HOST supports NTSync!
    # Check with: ls /dev/ntsync
    # If file doesn't exist, KEEP THIS COMMENTED or container won't start!
    # ===========================================================================
    # devices:
    #   - /dev/ntsync:/dev/ntsync

    # ===========================================================================
    # RESOURCE LIMITS (Optional - for production)
    # ===========================================================================
    deploy:
      resources:
        limits:
          cpus: '3.5'
          memory: 18G
        reservations:
          cpus: '2.0'
          memory: 8G

    # ===========================================================================
    # HEALTH CHECK
    # ===========================================================================
    healthcheck:
      test: [ "CMD-SHELL", "pgrep -f VRisingServer || exit 1" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 600s

    # ===========================================================================
    # LOGGING
    # ===========================================================================
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
