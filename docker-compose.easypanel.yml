# ==============================================================================
# V Rising ARM64 Server - Production Docker Compose
# ==============================================================================
# This is the production configuration for EasyPanel or direct Docker deploy
# For development, use docker-compose.yml instead
#
# Deploy options:
# 1. EasyPanel: Import this file via UI
# 2. Direct: docker compose -f docker-compose.easypanel.yml up -d
# ==============================================================================

services:
  vrising:
    # ===========================================================================
    # IMAGE CONFIGURATION
    # ===========================================================================
    # Option 1: Use pre-built image (RECOMMENDED for production)
    image: tsxcloud/vrising-ntsync:latest

    # Option 2: Build from local Dockerfile (uncomment below, comment image above)
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     WINE_VERSION: "10.15"

    container_name: vrising-server
    hostname: vrising

    # ===========================================================================
    # ENVIRONMENT VARIABLES
    # ===========================================================================
    environment:
      # --- Basic Configuration ---
      - TZ=America/Sao_Paulo
      - SERVERNAME=VRising-ARM64

      # --- BepInEx / Plugins ---
      - ENABLE_PLUGINS=true

      # --- Server Behavior ---
      - UPDATE_SERVER=true
      - LOGDAYS=30

      # --- Box64 Performance (ARM64) ---
      - BOX64_DYNAREC=1
      - BOX64_DYNAREC_FASTROUND=1
      - BOX64_DYNAREC_FASTNAN=1
      - BOX64_DYNAREC_SAFEFLAGS=0
      - BOX64_DYNAREC_BIGBLOCK=2
      - BOX64_DYNAREC_STRONGMEM=0
      - BOX64_DYNAREC_BLEEDING_EDGE=1
      - BOX64_MALLOC_HACK=1
      - BOX64_NOBANNER=1

      # --- Wine Performance ---
      - WINEDEBUG=-all
      - WINE_LARGE_ADDRESS_AWARE=1

    # ===========================================================================
    # VOLUMES - Persistent Data
    # ===========================================================================
    volumes:
      # Server files (Wine, V Rising, BepInEx)
      - vrising-server:/mnt/vrising/server
      # Persistent data (saves, configs, logs)
      - vrising-data:/mnt/vrising/persistentdata

    # ===========================================================================
    # PORTS
    # ===========================================================================
    ports:
      # Game Port (UDP) - REQUIRED
      - "9876:9876/udp"
      # Query Port (UDP) - For server browser
      - "9877:9877/udp"
      # RCON Port (TCP) - Remote administration (optional)
      - "25575:25575/tcp"
      # API/Metrics Port (TCP) - Prometheus metrics (optional)
      - "9099:9090/tcp"

    # ===========================================================================
    # RESOURCE LIMITS
    # ===========================================================================
    deploy:
      resources:
        limits:
          cpus: '3.5'
          memory: 18G
        reservations:
          cpus: '2.0'
          memory: 8G

    # ===========================================================================
    # RESTART POLICY
    # ===========================================================================
    restart: unless-stopped

    # ===========================================================================
    # GRACEFUL SHUTDOWN
    # Allow time for autosave before container stops
    # ===========================================================================
    stop_grace_period: 90s

    # ===========================================================================
    # NETWORK
    # ===========================================================================
    network_mode: bridge

    # ===========================================================================
    # NTSYNC DEVICE (Optional - Uncomment if host supports it)
    # Check with: ls /dev/ntsync
    # ===========================================================================
    # devices:
    #   - /dev/ntsync:/dev/ntsync

    # ===========================================================================
    # HEALTH CHECK
    # ===========================================================================
    healthcheck:
      test: [ "CMD-SHELL", "pgrep -f VRisingServer || exit 1" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 600s # 10 min - server takes time to download/start

    # ===========================================================================
    # LOGGING
    # ===========================================================================
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# ==============================================================================
# VOLUMES DEFINITION
# ==============================================================================
volumes:
  vrising-server:
    name: vrising-server
  vrising-data:
    name: vrising-data
